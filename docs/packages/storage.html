<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>storage.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2021 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This source file contains an implementation of interface between Go code and
(almost any) SQL database like PostgreSQL, SQLite, or MariaDB.</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Generated documentation is available at:
https://pkg.go.dev/github.com/RedHatInsights/ccx-notification-writer/</p>

<p>Documentation in literate-programming-style is available at:
https://redhatinsights.github.io/ccx-notification-writer/packages/storage.html</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>It is possible to configure connection to selected database by using
StorageConfiguration structure. Currently that structure contains two
configurable parameter:</p>

<p>Driver - a SQL driver, like &quot;sqlite3&quot;, &quot;pq&quot; etc.
DataSource - specification of data source. The content of this parameter depends on the database used.</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;errors&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>

	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div>           <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>

	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Table creation-related scripts</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This table contains list of all notification types used by
Notification service. Frequency can be specified as in <code>crontab</code> -
https://crontab.guru/</p>
</td>
	<td class="code"><pre><code>	<div class="ident">createTableNotificationTypes</div> <div class="operator">=</div> <div class="literal">`
                CREATE TABLE notification_types (
                    id          integer not null,
                    value       varchar not null,
                    frequency   varchar not null,
                    comment     varchar,
                
                    PRIMARY KEY (id)
                );
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This table contains states for each row stored in <code>reported</code> table.
User can be notified about the report, report can be skipped if the
same as previous, skipped because of lower pripority, or can be in
error state.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">createTableStates</div> <div class="operator">=</div> <div class="literal">`
                CREATE TABLE states (
                    id          integer not null,
                    value       varchar not null,
                    comment     varchar,
                
                    PRIMARY KEY (id)
                );
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Information of notifications reported to user or skipped due to some
conditions.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">createTableReported</div> <div class="operator">=</div> <div class="literal">`
                CREATE TABLE reported (
                    org_id            integer not null,
                    account_number    integer not null,
                    cluster           character(36) not null,
                    notification_type integer not null,
                    state             integer not null,
                    report            varchar not null,
                    updated_at        timestamp not null,
                    notified_at       timestamp not null,
		    error_log         varchar,
                
                    PRIMARY KEY (org_id, cluster, notified_at),
                    CONSTRAINT fk_notification_type
                        foreign key(notification_type)
                        references notification_types(id),
                    CONSTRAINT fk_state
                        foreign key (state)
                        references states(id)
                );
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This table contains new reports consumed from Kafka topic and stored
to database in shrunk format (some attributes are removed).</p>
</td>
	<td class="code"><pre><code>	<div class="ident">createTableNewReports</div> <div class="operator">=</div> <div class="literal">`
                CREATE TABLE new_reports (
                    org_id            integer not null,
                    account_number    integer not null,
                    cluster           character(36) not null,
                    report            varchar not null,
                    updated_at        timestamp not null,
                    kafka_offset      bigint not null default 0,
                
                    PRIMARY KEY (org_id, cluster, updated_at)
                );
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Index for the new_reports table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">createIndexKafkaOffset</div> <div class="operator">=</div> <div class="literal">`
                CREATE INDEX report_kafka_offset_btree_idx
		       ON new_reports (kafka_offset)
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in notification_types table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertInstantReport</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO notification_types (id, value, frequency, comment)
		            VALUES (1, &#39;instant&#39;, &#39;* * * * * *&#39;, &#39;instant notifications performed ASAP&#39;);
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in notification_types table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertWeeklySummary</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO notification_types (id, value, frequency, comment)
		            VALUES (2, &#39;weekly&#39;, &#39;@weekly&#39;, &#39;weekly summary&#39;);
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in states table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertSentState</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO states (id, value, comment)
		            VALUES (1, &#39;sent&#39;, &#39;notification has been sent to user&#39;);
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in states table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertSentSame</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO states (id, value, comment)
		            VALUES (2, &#39;same&#39;, &#39;skipped, report is the same as previous one&#39;);
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in states table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertSentLowPriority</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO states (id, value, comment)
		            VALUES (3, &#39;lower&#39;, &#39;skipped, all issues has low priority&#39;);
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Value to be stored in states table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertSentError</div> <div class="operator">=</div> <div class="literal">`
                INSERT INTO states (id, value, comment)
		            VALUES (4, &#39;error&#39;, &#39;notification delivery error&#39;);
`</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>SQL statements</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">InsertNewReportStatement</div> <div class="operator">=</div> <div class="literal">`
		INSERT INTO new_reports(org_id, account_number, cluster, report, updated_at, kafka_offset)
		VALUES ($1, $2, $3, $4, $5, $6);
	`</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">SQLStatementMessage</div> <div class="operator">=</div> <div class="literal">&#34;SQL statement&#34;</div><div class="operator"></div>
	<div class="ident">StatementMessage</div>    <div class="operator">=</div> <div class="literal">&#34;Statement&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Storage represents an interface to almost any database or storage system</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Storage</div> <div class="keyword">interface</div> <div class="operator">{</div>
	<div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">accountNumber</div> <div class="ident">AccountNumber</div><div class="operator">,</div>
		<div class="ident">clusterName</div> <div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">report</div> <div class="ident">ClusterReport</div><div class="operator">,</div>
		<div class="ident">collectedAtTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
		<div class="ident">kafkaOffset</div> <div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">DatabaseInitialization</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">DatabaseCleanup</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">DatabaseDropTables</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">DatabaseDropIndexes</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">KafkaOffset</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBStorage is an implementation of Storage interface that use selected SQL like database
like SQLite, PostgreSQL, MariaDB, RDS etc. That implementation is based on the standard
sql package. It is possible to configure connection via Configuration structure.
SQLQueriesLog is log for sql queries, default is nil which means nothing is logged</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DBStorage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">connection</div>   <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator"></div>
	<div class="ident">dbDriverType</div> <div class="ident">DBDriver</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ErrOldReport is an error returned if a more recent already
exists on the storage while attempting to write a report for a cluster.</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">ErrOldReport</div> <div class="operator">=</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;More recent report already exists in storage&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>tableNames contains names of all tables in the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">tableNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>indexNames contains names of all indexes in the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">indexNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initStatements contains all statements used to initialize database</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">initStatements</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewStorage function creates and initializes a new instance of Storage interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewStorage</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Initializing connection to storage&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">driverType</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unsupported driver&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;driver&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;datasource&#34;</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Making connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare connection</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>lazy initialization (TODO: use init function instead?)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tableNames</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;new_reports&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;reported&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;notification_types&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;states&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>lazy initialization (TODO: use init function instead?)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">indexNames</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;report_kafka_offset_btree_idx&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>lazy initialization (TODO: use init function instead?)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">initStatements</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>tables</p>
</td>
	<td class="code"><pre><code>		<div class="ident">createTableNotificationTypes</div><div class="operator">,</div>
		<div class="ident">createTableStates</div><div class="operator">,</div>
		<div class="ident">createTableReported</div><div class="operator">,</div>
		<div class="ident">createTableNewReports</div><div class="operator">,</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>offsets</p>
</td>
	<td class="code"><pre><code>		<div class="ident">createIndexKafkaOffset</div><div class="operator">,</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>records</p>
</td>
	<td class="code"><pre><code>		<div class="ident">insertInstantReport</div><div class="operator">,</div>
		<div class="ident">insertWeeklySummary</div><div class="operator">,</div>
		<div class="ident">insertSentState</div><div class="operator">,</div>
		<div class="ident">insertSentSame</div><div class="operator">,</div>
		<div class="ident">insertSentLowPriority</div><div class="operator">,</div>
		<div class="ident">insertSentError</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Connection to storage established&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">driverType</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewFromConnection function creates and initializes a new instance of Storage interface from prepared connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">dbDriverType</div> <div class="ident">DBDriver</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">DBStorage</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">DBStorage</div><div class="operator">{</div>
		<div class="ident">connection</div><div class="operator">:</div>   <div class="ident">connection</div><div class="operator">,</div>
		<div class="ident">dbDriverType</div><div class="operator">:</div> <div class="ident">dbDriverType</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initAndGetDriver initializes driver(with logs if logSQLQueries is true),
checks if it's supported and returns driver type, driver name, dataSource and error</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">driverType</div> <div class="ident">DBDriver</div><div class="operator">,</div> <div class="ident">driverName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">dataSource</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>var driver sql_driver.Driver</p>
</td>
	<td class="code"><pre><code>	<div class="ident">driverName</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">DBDriverSQLite3</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;sqlite3.SQLiteDriver{}
dataSource = configuration.SQLiteDataSource</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">DBDriverPostgres</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;pq.Driver{}</p>
</td>
	<td class="code"><pre><code>		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;postgresql://%v:%v@%v:%v/%v?%v&#34;</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPassword</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGParams</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;driver %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes the connection to database. Needs to be called at the end of application lifecycle.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Closing connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not close connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteReportForCluster writes result (health status) for selected cluster for given organization</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteReportForCluster</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">accountNumber</div> <div class="ident">AccountNumber</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">lastCheckedTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
	<div class="ident">kafkaOffset</div> <div class="ident">KafkaOffset</div><div class="operator">,</div>
<div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">!=</div> <div class="ident">DBDriverSQLite3</div> <div class="operator">&amp;&amp;</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">!=</div> <div class="ident">DBDriverPostgres</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;Writing report with DB %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Begin a new transaction.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">insertReport</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">accountNumber</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">kafkaOffset</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">insertReport</div><div class="operator">(</div>
	<div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">accountNumber</div> <div class="ident">AccountNumber</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">lastCheckedTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
	<div class="ident">kafkaOffset</div> <div class="ident">KafkaOffset</div><div class="operator">,</div>
<div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">InsertNewReportStatement</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">accountNumber</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">kafkaOffset</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;org&#34;</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;account&#34;</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">accountNumber</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int64</div><div class="operator">(</div><div class="literal">&#34;kafka offset&#34;</div><div class="operator">,</div> <div class="ident">int64</div><div class="operator">(</div><div class="ident">kafkaOffset</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;last checked&#34;</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">.</div><div class="ident">String</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to insert the cluster report&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>finishTransaction finishes the transaction depending on err. err == nil -&gt; commit, err != nil -&gt; rollback</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">rollbackError</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">rollbackError</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">rollbackError</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Error when trying to rollback a transaction&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">commitError</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Commit</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">commitError</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">commitError</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Error when trying to commit a transaction&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">_</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">tablesRelatedOperation</div><div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">cmd</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">string</div><div class="operator">)</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Begin a new transaction.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform some operation to all tables</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableNames</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>it is not possible to use parameter for table name or a key
disable &quot;G202 (CWE-89): SQL string concatenation (Confidence: HIGH, Severity: MEDIUM)&quot;</p>

<h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>			<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="ident">cmd</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">StatementMessage</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">SQLStatementMessage</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>println(sqlStatement)</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the SQL statement in transaction</p>
</td>
	<td class="code"><pre><code>			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">deleteFromTableStatement</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="literal">&#34;DELETE FROM &#34;</div> <div class="operator">&#43;</div> <div class="ident">tableName</div> <div class="operator">&#43;</div> <div class="literal">&#34;;&#34;</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DatabaseCleanup method performs database cleanup - deletes content of all
tables in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DatabaseCleanup</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tablesRelatedOperation</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">deleteFromTableStatement</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">dropTableStatement</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="literal">&#34;DROP TABLE &#34;</div> <div class="operator">&#43;</div> <div class="ident">tableName</div> <div class="operator">&#43;</div> <div class="literal">&#34;;&#34;</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DatabaseDropTables method performs database drop for all tables in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DatabaseDropTables</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tablesRelatedOperation</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">dropTableStatement</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">dropIndexStatement</div><div class="operator">(</div><div class="ident">indexName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="literal">&#34;DROP INDEX IF EXISTS &#34;</div> <div class="operator">&#43;</div> <div class="ident">indexName</div> <div class="operator">&#43;</div> <div class="literal">&#34;;&#34;</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DatabaseDropIndexes method performs database drop for all tables in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DatabaseDropIndexes</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tablesRelatedOperation</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">dropIndexStatement</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DatabaseInitialization method performs database initialization - creates all
tables in database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DatabaseInitialization</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Begin a new transaction.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>databaze initialization</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">initStatements</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">StatementMessage</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">SQLStatementMessage</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>println(sqlStatement)</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the SQL statement in transaction</p>
</td>
	<td class="code"><pre><code>			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetLatestKafkaOffset returns latest kafka offset from report table</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">KafkaOffset</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">offset</div> <div class="ident">KafkaOffset</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">&#34;SELECT COALESCE(MAX(kafka_offset), 0) FROM new_reports;&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
