<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>consumer.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>consumer.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2021 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This file contains interface for any consumer that is able to process
messages. It also contains implementation of Kafka consumer.</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;context&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;errors&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/Shopify/sarama&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/google/uuid&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for topic name used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">topicKey</div> <div class="operator">=</div> <div class="literal">&#34;topic&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for broker group name used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">groupKey</div> <div class="operator">=</div> <div class="literal">&#34;group&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for message offset used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">offsetKey</div> <div class="operator">=</div> <div class="literal">&#34;offset&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for message partition used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">partitionKey</div> <div class="operator">=</div> <div class="literal">&#34;partition&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for organization ID used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">organizationKey</div> <div class="operator">=</div> <div class="literal">&#34;organization&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for cluster ID used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterKey</div> <div class="operator">=</div> <div class="literal">&#34;cluster&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for data schema version message type used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">versionKey</div> <div class="operator">=</div> <div class="literal">&#34;version&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>key for duration message type used in structured log messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">durationKey</div> <div class="operator">=</div> <div class="literal">&#34;duration&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CurrentSchemaVersion represents the currently supported data schema version</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="ident">CurrentSchemaVersion</div> <div class="operator">=</div> <div class="ident">SchemaVersion</div><div class="operator">(</div><div class="literal">2</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Report represents report send in a message consumed from any broker</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Report</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="operator">*</div><div class="ident">json</div><div class="operator">.</div><div class="ident">RawMessage</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>incomingMessage is representation of message consumed from any broker</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">incomingMessage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Organization</div>  <div class="operator">*</div><div class="ident">OrgID</div>         <div class="literal">`json:&#34;OrgID&#34;`</div><div class="operator"></div>
	<div class="ident">AccountNumber</div> <div class="operator">*</div><div class="ident">AccountNumber</div> <div class="literal">`json:&#34;AccountNumber&#34;`</div><div class="operator"></div>
	<div class="ident">ClusterName</div>   <div class="operator">*</div><div class="ident">ClusterName</div>   <div class="literal">`json:&#34;ClusterName&#34;`</div><div class="operator"></div>
	<div class="ident">Report</div>        <div class="operator">*</div><div class="ident">Report</div>        <div class="literal">`json:&#34;Report&#34;`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>LastChecked is a date in format &quot;2020-01-23T16:15:59.478901889Z&quot;</p>
</td>
	<td class="code"><pre><code>	<div class="ident">LastChecked</div> <div class="ident">string</div>        <div class="literal">`json:&#34;LastChecked&#34;`</div><div class="operator"></div>
	<div class="ident">Version</div>     <div class="ident">SchemaVersion</div> <div class="literal">`json:&#34;Version&#34;`</div><div class="operator"></div>
	<div class="ident">RequestID</div>   <div class="ident">RequestID</div>     <div class="literal">`json:&#34;RequestId&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Consumer represents any consumer of insights-rules messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Consumer</div> <div class="keyword">interface</div> <div class="operator">{</div>
	<div class="ident">Serve</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ProcessMessage</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>KafkaConsumer in an implementation of Consumer interface
Example:</p>

<p>kafkaConsumer, err := consumer.New(brokerCfg, storage)
if err != nil {
    panic(err)
}</p>

<p>kafkaConsumer.Serve()</p>

<p>err := kafkaConsumer.Stop()
if err != nil {
    panic(err)
}</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">KafkaConsumer</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Configuration</div>                        <div class="ident">BrokerConfiguration</div><div class="operator"></div>
	<div class="ident">ConsumerGroup</div>                        <div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerGroup</div><div class="operator"></div>
	<div class="ident">storage</div>                              <div class="ident">Storage</div><div class="operator"></div>
	<div class="ident">numberOfSuccessfullyConsumedMessages</div> <div class="ident">uint64</div><div class="operator"></div>
	<div class="ident">numberOfErrorsConsumingMessages</div>      <div class="ident">uint64</div><div class="operator"></div>
	<div class="ident">ready</div>                                <div class="keyword">chan</div> <div class="ident">bool</div><div class="operator"></div>
	<div class="ident">cancel</div>                               <div class="ident">context</div><div class="operator">.</div><div class="ident">CancelFunc</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DefaultSaramaConfig is a config which will be used by default
here you can use specific version of a protocol for example
useful for testing</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">DefaultSaramaConfig</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">Config</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewConsumer constructs new implementation of Consumer interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewConsumer</div><div class="operator">(</div><div class="ident">brokerCfg</div> <div class="ident">BrokerConfiguration</div><div class="operator">,</div> <div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">NewWithSaramaConfig</div><div class="operator">(</div><div class="ident">brokerCfg</div><div class="operator">,</div> <div class="ident">DefaultSaramaConfig</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewWithSaramaConfig constructs new implementation of Consumer interface with custom sarama config</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewWithSaramaConfig</div><div class="operator">(</div>
	<div class="ident">brokerCfg</div> <div class="ident">BrokerConfiguration</div><div class="operator">,</div>
	<div class="ident">saramaConfig</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">,</div>
	<div class="ident">storage</div> <div class="ident">Storage</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">saramaConfig</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">saramaConfig</div> <div class="operator">=</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">NewConfig</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">saramaConfig</div><div class="operator">.</div><div class="ident">Version</div> <div class="operator">=</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">V0_10_2_0</div><div class="operator"></div>

		<div class="comment">/* TODO: we need to do it in production code
		if brokerCfg.Timeout &gt; 0 {
			saramaConfig.Net.DialTimeout = brokerCfg.Timeout
			saramaConfig.Net.ReadTimeout = brokerCfg.Timeout
			saramaConfig.Net.WriteTimeout = brokerCfg.Timeout
		}
		*/</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">consumerGroup</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">NewConsumerGroup</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="ident">brokerCfg</div><div class="operator">.</div><div class="ident">Address</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">brokerCfg</div><div class="operator">.</div><div class="ident">Group</div><div class="operator">,</div> <div class="ident">saramaConfig</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">consumer</div> <div class="operator">:=</div> <div class="operator">&amp;</div><div class="ident">KafkaConsumer</div><div class="operator">{</div>
		<div class="ident">Configuration</div><div class="operator">:</div>                        <div class="ident">brokerCfg</div><div class="operator">,</div>
		<div class="ident">ConsumerGroup</div><div class="operator">:</div>                        <div class="ident">consumerGroup</div><div class="operator">,</div>
		<div class="ident">storage</div><div class="operator">:</div>                              <div class="ident">storage</div><div class="operator">,</div>
		<div class="ident">numberOfSuccessfullyConsumedMessages</div><div class="operator">:</div> <div class="literal">0</div><div class="operator">,</div>
		<div class="ident">numberOfErrorsConsumingMessages</div><div class="operator">:</div>      <div class="literal">0</div><div class="operator">,</div>
		<div class="ident">ready</div><div class="operator">:</div>                                <div class="ident">make</div><div class="operator">(</div><div class="keyword">chan</div> <div class="ident">bool</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">consumer</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Serve starts listening for messages and processing them. It blocks current thread.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">Serve</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ctx</div><div class="operator">,</div> <div class="ident">cancel</div> <div class="operator">:=</div> <div class="ident">context</div><div class="operator">.</div><div class="ident">WithCancel</div><div class="operator">(</div><div class="ident">context</div><div class="operator">.</div><div class="ident">Background</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">consumer</div><div class="operator">.</div><div class="ident">cancel</div> <div class="operator">=</div> <div class="ident">cancel</div><div class="operator"></div>

	<div class="keyword">go</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p><code>Consume</code> should be called inside an infinite loop, when a
server-side rebalance happens, the consumer session will need to be
recreated to get the new claims</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ConsumerGroup</div><div class="operator">.</div><div class="ident">Consume</div><div class="operator">(</div><div class="ident">ctx</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">consumer</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to recreate Kafka session&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if context was cancelled, signaling that the consumer should stop</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="ident">ctx</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">ctx</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Stopping consumer&#34;</div><div class="operator">)</div><div class="operator"></div>
				<div class="keyword">return</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>

			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Created new kafka session&#34;</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">consumer</div><div class="operator">.</div><div class="ident">ready</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">chan</div> <div class="ident">bool</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Await till the consumer has been set up</p>
</td>
	<td class="code"><pre><code>	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Waiting for consumer to become ready&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">&lt;-</div><div class="ident">consumer</div><div class="operator">.</div><div class="ident">ready</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Finished waiting for consumer to become ready&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Actual processing is done in goroutine created by sarama (see ConsumeClaim below)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Started serving consumer&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">&lt;-</div><div class="ident">ctx</div><div class="operator">.</div><div class="ident">Done</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Context cancelled, exiting&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">cancel</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Setup is run at the beginning of a new session, before ConsumeClaim</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">Setup</div><div class="operator">(</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerGroupSession</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;New session has been setup&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Mark the consumer as ready</p>
</td>
	<td class="code"><pre><code>	<div class="ident">close</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">.</div><div class="ident">ready</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Cleanup is run at the end of a session, once all ConsumeClaim goroutines have exited</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">Cleanup</div><div class="operator">(</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerGroupSession</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;New session has been finished&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ConsumeClaim starts a consumer loop of ConsumerGroupClaim's Messages().</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">ConsumeClaim</div><div class="operator">(</div><div class="ident">session</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerGroupSession</div><div class="operator">,</div> <div class="ident">claim</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerGroupClaim</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">claim</div><div class="operator">.</div><div class="ident">InitialOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Starting messages loop&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">latestMessageOffset</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to get latest offset&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">latestMessageOffset</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="literal">&#34;Offset in DB&#34;</div><div class="operator">,</div> <div class="ident">int64</div><div class="operator">(</div><div class="ident">latestMessageOffset</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Latest offset read from database&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">message</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">claim</div><div class="operator">.</div><div class="ident">Messages</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">KafkaOffset</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div> <div class="operator">&lt;=</div> <div class="ident">latestMessageOffset</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Warn</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;This offset was already processed by aggregator&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">HandleMessage</div><div class="operator">(</div><div class="ident">message</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">session</div><div class="operator">.</div><div class="ident">MarkMessage</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">KafkaOffset</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div> <div class="operator">&gt;</div> <div class="ident">latestMessageOffset</div> <div class="operator">{</div>
			<div class="ident">latestMessageOffset</div> <div class="operator">=</div> <div class="ident">KafkaOffset</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">int64</div><div class="operator">(</div><div class="ident">latestMessageOffset</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Updating latest message offset&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes all resources used by consumer</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">cancel</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">cancel</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ConsumerGroup</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ConsumerGroup</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to close consumer group&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetNumberOfSuccessfullyConsumedMessages returns number of consumed messages
since creating KafkaConsumer obj</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">GetNumberOfSuccessfullyConsumedMessages</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">uint64</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfSuccessfullyConsumedMessages</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetNumberOfErrorsConsumingMessages returns number of errors during consuming messages
since creating KafkaConsumer obj</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">GetNumberOfErrorsConsumingMessages</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">uint64</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfErrorsConsumingMessages</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>HandleMessage handles the message and does all logging, metrics, etc</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">HandleMessage</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int32</div><div class="operator">(</div><div class="ident">partitionKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Partition</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Time</div><div class="operator">(</div><div class="literal">&#34;message_timestamp&#34;</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Started processing message&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">ConsumedMessages</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">startTime</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">requestID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ProcessMessage</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">timeAfterProcessingMessage</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">messageProcessingDuration</div> <div class="operator">:=</div> <div class="ident">timeAfterProcessingMessage</div><div class="operator">.</div><div class="ident">Sub</div><div class="operator">(</div><div class="ident">startTime</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Seconds</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int32</div><div class="operator">(</div><div class="ident">partitionKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Partition</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Request ID&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Processing of message took &#39;%v&#39; seconds&#34;</div><div class="operator">,</div> <div class="ident">messageProcessingDuration</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Something went wrong while processing the message.</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">ConsumingErrors</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Error processing message consumed from Kafka&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfErrorsConsumingMessages</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>The message was processed successfully.</p>
</td>
	<td class="code"><pre><code>		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfSuccessfullyConsumedMessages</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">totalMessageDuration</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">startTime</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="literal">&#34;duration&#34;</div><div class="operator">,</div> <div class="ident">totalMessageDuration</div><div class="operator">.</div><div class="ident">Milliseconds</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Message consumed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkMessageVersion - verifies incoming data's version is the expected one</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkMessageVersion</div><div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">,</div> <div class="ident">message</div> <div class="operator">*</div><div class="ident">incomingMessage</div><div class="operator">,</div> <div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">Version</div> <div class="operator">!=</div> <div class="ident">CurrentSchemaVersion</div> <div class="operator">{</div>
		<div class="keyword">const</div> <div class="ident">warning</div> <div class="operator">=</div> <div class="literal">&#34;Received data with unexpected version.&#34;</div><div class="operator"></div>
		<div class="ident">logMessageWarning</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">message</div><div class="operator">,</div> <div class="ident">warning</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>shrinkMessage function shrink the original message by removing unused parts.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">shrinkMessage</div><div class="operator">(</div><div class="ident">message</div> <div class="operator">*</div><div class="ident">Report</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>delete all unneeded 'root' attributes</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;system&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;fingerprints&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;skips&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;info&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;pass&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>tryToDeleteAttribute function deletes selected attribute from input map. If
attribute does not exists, it is skipped silently.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">tryToDeleteAttribute</div><div class="operator">(</div><div class="ident">message</div> <div class="operator">*</div><div class="ident">Report</div><div class="operator">,</div> <div class="ident">attributeName</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">message</div><div class="operator">)</div><div class="operator">[</div><div class="ident">attributeName</div><div class="operator">]</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">found</div> <div class="operator">{</div>
		<div class="ident">delete</div><div class="operator">(</div><div class="operator">*</div><div class="ident">message</div><div class="operator">,</div> <div class="ident">attributeName</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>let's ingore 'not-found' state as we just need to remove the
attribute, not to check message schema</p>
</td>
	<td class="code"><pre><code><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ProcessMessage processes an incoming message</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">ProcessMessage</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">tStart</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #1: parse the incomming message</p>
</td>
	<td class="code"><pre><code>	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">groupKey</div><div class="operator">,</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">Group</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Consumed&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">message</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">parseMessage</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Value</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logUnparsedMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="literal">&#34;Error parsing message from Kafka&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of parsed messages</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ParsedIncomingMessage</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Read&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tRead</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #2: check message (schema) version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">checkMessageVersion</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">message</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of messages with successfull schema check</p>
</td>
	<td class="code"><pre><code>	<div class="ident">CheckSchemaVersion</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #3: marshall report into byte slice to figure out original length</p>
</td>
	<td class="code"><pre><code>	<div class="ident">reportAsBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div><div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error marshalling report&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of marshaled reports</p>
</td>
	<td class="code"><pre><code>	<div class="ident">MarshalReport</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Marshalled&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tMarshalled</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #4: shrink the Report structure</p>
</td>
	<td class="code"><pre><code>	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Shrinking message&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">shrinkMessage</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">shrinkedAsBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div><div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error marshalling skrinked report&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">logShrinkedMessage</div><div class="operator">(</div><div class="ident">reportAsBytes</div><div class="operator">,</div> <div class="ident">shrinkedAsBytes</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of shrinked reports</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ShrinkReport</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">tShrinked</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #5: check the last checked timestamp</p>
</td>
	<td class="code"><pre><code>	<div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339Nano</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">LastChecked</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error parsing date from message&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">lastCheckedTimestampLagMinutes</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Sub</div><div class="operator">(</div><div class="ident">lastCheckedTime</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Minutes</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">lastCheckedTimestampLagMinutes</div> <div class="operator">&lt;</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Got a message from the future&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of messages with last checked timestamp</p>
</td>
	<td class="code"><pre><code>	<div class="ident">CheckLastCheckedTimestamp</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Time ok&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">tTimeCheck</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">kafkaOffset</div> <div class="operator">:=</div> <div class="ident">KafkaOffset</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #6: write the shrinked report into storage (database)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Organization</div><div class="operator">,</div>
		<div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">,</div>
		<div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ClusterReport</div><div class="operator">(</div><div class="ident">shrinkedAsBytes</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">tTimeCheck</div><div class="operator">,</div>
		<div class="ident">kafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">ErrOldReport</div> <div class="operator">{</div>
			<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Skipping because a more recent report already exists for this cluster&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error writing report to database&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of messages stored into database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">StoredMessages</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>update metric - number of bytes stored into database
beware: counter value is represented as float64, not as bytes as you'd expect</p>
</td>
	<td class="code"><pre><code>	<div class="ident">StoredBytes</div><div class="operator">.</div><div class="ident">Add</div><div class="operator">(</div><div class="ident">float64</div><div class="operator">(</div><div class="ident">len</div><div class="operator">(</div><div class="ident">shrinkedAsBytes</div><div class="operator">)</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Stored&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tStored</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step #7: print durations of all previous steps</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log durations for every message consumption steps</p>
</td>
	<td class="code"><pre><code>	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tStart</div><div class="operator">,</div> <div class="ident">tRead</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;Read duration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tRead</div><div class="operator">,</div> <div class="ident">tMarshalled</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;Marshalling duration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tMarshalled</div><div class="operator">,</div> <div class="ident">tShrinked</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;Shrinking duration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tShrinked</div><div class="operator">,</div> <div class="ident">tTimeCheck</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;Time check duration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tTimeCheck</div><div class="operator">,</div> <div class="ident">tStored</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;DB store duration&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>message has been parsed and stored into storage</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>logShrinkedMessage function prints/logs information about status of
shrinking the message.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">logShrinkedMessage</div><div class="operator">(</div><div class="ident">reportAsBytes</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">,</div> <div class="ident">shrinkedAsBytes</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">orig</div> <div class="operator">:=</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">reportAsBytes</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">shrinked</div> <div class="operator">:=</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">shrinkedAsBytes</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">percentage</div> <div class="operator">:=</div> <div class="ident">int</div><div class="operator">(</div><div class="literal">100.0</div> <div class="operator">*</div> <div class="ident">shrinked</div> <div class="operator">/</div> <div class="ident">orig</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;Original size&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">reportAsBytes</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;Shrinked size&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">shrinkedAsBytes</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;Ratio (%)&#34;</div><div class="operator">,</div> <div class="ident">percentage</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Message shrinked&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkReportStructure tests if the report has correct structure</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkReportStructure</div><div class="operator">(</div><div class="ident">r</div> <div class="ident">Report</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>the structure is not well defined yet, so all we should do is to check if all keys are there</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedKeys</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;fingerprints&#34;</div><div class="operator">,</div> <div class="literal">&#34;info&#34;</div><div class="operator">,</div> <div class="literal">&#34;reports&#34;</div><div class="operator">,</div> <div class="literal">&#34;skips&#34;</div><div class="operator">,</div> <div class="literal">&#34;system&#34;</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">expectedKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">expectedKeys</div> <div class="operator">{</div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">r</div><div class="operator">[</div><div class="ident">expectedKey</div><div class="operator">]</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">found</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;Improper report structure, missing key &#34;</div> <div class="operator">&#43;</div> <div class="ident">expectedKey</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>parseMessage tries to parse incoming message and read all required attributes from it</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">parseMessage</div><div class="operator">(</div><div class="ident">messageValue</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">incomingMessage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">deserialized</div> <div class="ident">incomingMessage</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">messageValue</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">deserialized</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Organization</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;OrgID&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">AccountNumber</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;AccountNumber&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">ClusterName</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;ClusterName&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;Report&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">uuid</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">string</div><div class="operator">(</div><div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;cluster name is not a UUID&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">checkReportStructure</div><div class="operator">(</div><div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Deserialized report read from message with improper structure: %v&#34;</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
